# 论文阅读：Isolation Without Taxation

软件沙箱或基于软件的故障隔离（SFI）是一种将不受信任的组件组合成安全系统的轻量级方法。例如，Mozilla使用SFI来通过对第三方库进行沙箱隔离来加强Firefox浏览器的安全性，而Fastly和Cloudflare等公司则使用SFI来在其边缘云上安全地共存不受信任的租户。虽然已经做了大量的工作来优化和验证SFI执行，但是在SFI系统中的上下文切换仍然很少被探索：几乎所有的SFI系统都使用沉重的转换，这些转换不仅容易出错，而且在上下文切换时会产生重大的性能开销，因为要保存、清除和恢复寄存器。我们确定了一组零成本条件，这些条件特征是沙箱化代码具有足够的结构，通过轻量级的零成本转换（简单的函数调用）保证安全。

我们修改了Lucet Wasm编译器及其运行时，使用零成本转换，消除了依赖Lucet进行沙箱隔离的系统上的不必要性能损失（例如，我们将Firefox中的图像和字体渲染加速了高达29.7%和10%）。为了将Lucet编译器及其正确实现的Wasm规范从可信计算基础中移除，我们开发了一个静态二进制验证器VeriZero，它可以在几秒钟内检查由Lucet生成的二进制文件是否满足我们的零成本条件，并且通过开发逻辑关系证明了VeriZero的正确性，这个逻辑关系捕捉了编译的Wasm函数何时在我们的零成本条件下语义上是良好行为的。最后，我们展示了我们的模型在Wasm之外的用途，描述了一个新的、专门构建的SFI系统SegmentZero32，该系统使用x86分段和LLVM大多数现成的编译器来实现我们的零成本条件，我们的原型系统的性能与最先进的Native Client SFI系统相当。

## 一组零成本条件，这些条件对沙盒化代码施加了足够的内部结构

重量级的转换是保守的，因为它们对于在沙盒中运行的代码的结构（或可能的行为）做出了很少的假设。像NaCl和Wasm这样的SFI系统会对沙盒化代码进行结构化限制以强制实施内存隔离。本节中，我们展示了通过对沙盒化代码施加结构来使转换变得不那么保守。具体而言，我们描述了一组零成本条件，这些条件对沙盒化代码施加了足够的内部结构，以确保它的行为类似于高级组合语言，同时保持SFI的高性能。满足这些条件的SFI系统可以安全地省略几乎所有重量级跳板和跳转所做的额外工作，从而朝着将SFI转换作为简单、快速和可移植函数调用的理想目标迈进。

零成本条件。我们假设沙盒化的库代码被拆分为函数，并且每个函数都有一个预期的参数数量。我们通过一个安全监视器来规范化库代码所需的内部结构，该监视器检查零成本条件，即确保调用和从不受信任的库函数返回的本地要求是“良好行为”的条件，因此它们满足安全转换要求。

被调用者保存的寄存器恢复。首先，我们的监视器强制执行对被调用者保存的寄存器约定的函数调用级别的依从性：我们的监视器跟踪被调用者保存的状态，并检查在返回时是否正确恢复。重要的是，满足监视器意味着应用程序对良好行为的库函数的调用不需要进行单独的保存和恢复被调用者保存的寄存器的转换，因为已知该函数遵守标准调用约定。
